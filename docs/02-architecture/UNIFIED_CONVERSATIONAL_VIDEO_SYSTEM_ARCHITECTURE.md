# ç»Ÿä¸€å¯¹è¯å¼è§†é¢‘ç”Ÿæˆç¼–è¾‘ç³»ç»Ÿæ¶æ„è®¾è®¡

**è®¾è®¡ç›®æ ‡**: åˆ›å»ºä¸€ä¸ªä»¥å¯¹è¯ä¸ºä¸­å¿ƒçš„è§†é¢‘ç”Ÿæˆç¼–è¾‘ç³»ç»Ÿï¼Œé€šè¿‡æ™ºèƒ½èŠå¤©ç•Œé¢åè°ƒå¤šä¸ªä¸“ä¸šæ™ºèƒ½ä½“ï¼Œåœ¨å•ä¸€å¯¹è¯ä½“éªŒä¸­å®Œæˆè§†é¢‘åˆ›ä½œçš„å…¨æµç¨‹ã€‚

---

## ğŸ¯ æ ¸å¿ƒç†å¿µ

### è®¾è®¡åŸåˆ™

1. **å¯¹è¯ä¼˜å…ˆ** - èŠå¤©æ˜¯å”¯ä¸€çš„ç”¨æˆ·ç•Œé¢ï¼Œæ‰€æœ‰æ“ä½œé€šè¿‡å¯¹è¯å®Œæˆ
2. **æ™ºèƒ½ä½“åä½œ** - å¤šä¸ªä¸“ä¸šæ™ºèƒ½ä½“é€šè¿‡å·¥ä½œæµå¼•æ“ååŒå·¥ä½œ
3. **ä¸Šä¸‹æ–‡æ„ŸçŸ¥** - ç³»ç»Ÿç†è§£å¯¹è¯å†å²å’Œè§†é¢‘é¡¹ç›®çŠ¶æ€
4. **å®æ—¶åé¦ˆ** - é€šè¿‡å¯¹è¯æä¾›ç”Ÿæˆè¿›åº¦å’Œç»“æœé¢„è§ˆ
5. **è¿­ä»£ä¼˜åŒ–** - æ”¯æŒé€šè¿‡å¯¹è¯è¿›è¡Œå¤šè½®ä¿®æ”¹å’Œå®Œå–„

### ç”¨æˆ·ä½“éªŒæµç¨‹

```
ç”¨æˆ·: "æˆ‘æƒ³åˆ›å»ºä¸€ä¸ªå…³äºæ˜¥å¤©çš„çŸ­è§†é¢‘"
ç³»ç»Ÿ: "å¥½çš„ï¼æˆ‘å°†ä¸ºæ‚¨åˆ›å»ºä¸€ä¸ªæ˜¥å¤©ä¸»é¢˜çš„è§†é¢‘ã€‚è®©æˆ‘å…ˆæ„æ€å‰§æœ¬..."
     [Script Writer Agent å·¥ä½œä¸­]
ç³»ç»Ÿ: "å‰§æœ¬å·²å®Œæˆï¼æ•…äº‹è®²è¿°äº†æ˜¥å¤©èŠ±å¼€çš„ç¾æ™¯ã€‚è¦æŸ¥çœ‹è¯¦ç»†å‰§æœ¬å—ï¼Ÿ"
ç”¨æˆ·: "çœ‹èµ·æ¥ä¸é”™ï¼Œç»§ç»­ç”Ÿæˆè§†é¢‘"
ç³»ç»Ÿ: "å¼€å§‹ç”Ÿæˆè§†é¢‘..."
     [Video Generator Agent å·¥ä½œä¸­]
ç³»ç»Ÿ: "è§†é¢‘ç”Ÿæˆå®Œæˆï¼[é¢„è§ˆå›¾] æ‚¨è§‰å¾—æ€ä¹ˆæ ·ï¼Ÿ"
ç”¨æˆ·: "ç¬¬äºŒä¸ªé•œå¤´å¤ªæš—äº†ï¼Œèƒ½è°ƒäº®ä¸€äº›å—ï¼Ÿ"
ç³»ç»Ÿ: "å¥½çš„ï¼Œæˆ‘æ¥è°ƒæ•´ç¬¬äºŒä¸ªé•œå¤´çš„äº®åº¦..."
     [Editor Agent å·¥ä½œä¸­]
ç³»ç»Ÿ: "å·²è°ƒæ•´å®Œæˆï¼[æ›´æ–°çš„é¢„è§ˆ] ç°åœ¨æ•ˆæœå¦‚ä½•ï¼Ÿ"
```

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Conversational Interface                  â”‚
â”‚                     (Single Chat UI)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Conversational Orchestrator                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Intent Understanding & Context Management            â”‚  â”‚
â”‚  â”‚  - Natural Language Understanding                     â”‚  â”‚
â”‚  â”‚  - Conversation History Tracking                      â”‚  â”‚
â”‚  â”‚  - Project State Management                           â”‚  â”‚
â”‚  â”‚  - User Preference Learning                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Agent Coordination & Workflow Engine                 â”‚  â”‚
â”‚  â”‚  - Agent Selection & Routing                          â”‚  â”‚
â”‚  â”‚  - Task Decomposition                                 â”‚  â”‚
â”‚  â”‚  - Parallel/Sequential Execution                      â”‚  â”‚
â”‚  â”‚  - Result Aggregation                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                â”‚                â”‚
        â–¼                â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Script Writer â”‚  â”‚Video Generatorâ”‚  â”‚Editor Agent  â”‚
â”‚   Agent      â”‚  â”‚    Agent      â”‚  â”‚              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚- Story       â”‚  â”‚- Scene Gen   â”‚  â”‚- Cut/Trim    â”‚
â”‚- Dialogue    â”‚  â”‚- Character   â”‚  â”‚- Color Grade â”‚
â”‚- Narration   â”‚  â”‚- Storyboard  â”‚  â”‚- Effects     â”‚
â”‚- Structure   â”‚  â”‚- Video Comp  â”‚  â”‚- Transitions â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                â”‚                â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Reviewer Agent                              â”‚
â”‚  - Quality Check                                             â”‚
â”‚  - Consistency Validation                                    â”‚
â”‚  - Suggestion Generation                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Shared Knowledge Base                           â”‚
â”‚  - Project Assets (videos, images, audio)                   â”‚
â”‚  - Conversation History                                      â”‚
â”‚  - Workflow State                                            â”‚
â”‚  - User Preferences                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¤– æ ¸å¿ƒç»„ä»¶è®¾è®¡

### 1. Conversational Orchestrator (å¯¹è¯ç¼–æ’å™¨)

**èŒè´£**: ä½œä¸ºç³»ç»Ÿå¤§è„‘ï¼Œç†è§£ç”¨æˆ·æ„å›¾å¹¶åè°ƒæ‰€æœ‰æ™ºèƒ½ä½“

#### 1.1 Intent Understanding Module

```python
class IntentUnderstandingModule:
    """
    ç†è§£ç”¨æˆ·æ„å›¾å¹¶æå–å…³é”®ä¿¡æ¯
    """
    
    async def analyze_message(
        self,
        message: str,
        conversation_history: List[Message],
        project_context: ProjectContext
    ) -> Intent:
        """
        åˆ†æç”¨æˆ·æ¶ˆæ¯ï¼Œè¿”å›ç»“æ„åŒ–æ„å›¾
        
        Intentç±»å‹:
        - CREATE_VIDEO: åˆ›å»ºæ–°è§†é¢‘
        - MODIFY_VIDEO: ä¿®æ”¹ç°æœ‰è§†é¢‘
        - REVIEW_VIDEO: æŸ¥çœ‹/è¯„å®¡è§†é¢‘
        - QUERY_STATUS: æŸ¥è¯¢è¿›åº¦
        - PROVIDE_FEEDBACK: æä¾›åé¦ˆ
        - REFINE_CONTENT: ç»†åŒ–å†…å®¹
        """
        
        # ä½¿ç”¨LLMç†è§£æ„å›¾
        intent_prompt = self._build_intent_prompt(
            message, 
            conversation_history,
            project_context
        )
        
        intent_result = await self.llm.analyze(intent_prompt)
        
        return Intent(
            type=intent_result.intent_type,
            confidence=intent_result.confidence,
            entities=intent_result.extracted_entities,
            context=intent_result.context_requirements
        )
```

#### 1.2 Context Management Module

```python
class ConversationContextManager:
    """
    ç®¡ç†å¯¹è¯ä¸Šä¸‹æ–‡å’Œé¡¹ç›®çŠ¶æ€
    """
    
    def __init__(self):
        self.conversation_history: List[Message] = []
        self.project_state: ProjectState = None
        self.active_agents: Dict[str, Agent] = {}
        self.pending_tasks: List[Task] = []
    
    async def update_context(
        self,
        user_message: str,
        system_response: str,
        agent_results: Dict[str, Any]
    ):
        """æ›´æ–°å¯¹è¯ä¸Šä¸‹æ–‡"""
        
        # æ·»åŠ åˆ°å†å²
        self.conversation_history.append(
            Message(role="user", content=user_message)
        )
        self.conversation_history.append(
            Message(role="assistant", content=system_response)
        )
        
        # æ›´æ–°é¡¹ç›®çŠ¶æ€
        if agent_results:
            await self._update_project_state(agent_results)
        
        # ä¿æŒä¸Šä¸‹æ–‡çª—å£å¤§å°
        if len(self.conversation_history) > MAX_CONTEXT_LENGTH:
            self._compress_history()
    
    def get_relevant_context(self, intent: Intent) -> Dict[str, Any]:
        """è·å–ä¸å½“å‰æ„å›¾ç›¸å…³çš„ä¸Šä¸‹æ–‡"""
        
        return {
            "recent_messages": self.conversation_history[-10:],
            "project_state": self.project_state.to_dict(),
            "active_workflows": [t.to_dict() for t in self.pending_tasks],
            "user_preferences": self._get_user_preferences()
        }
```

#### 1.3 Agent Coordination Module

```python
class AgentCoordinator:
    """
    åè°ƒå¤šä¸ªæ™ºèƒ½ä½“çš„å·¥ä½œ
    """
    
    def __init__(self):
        self.agents = {
            "script_writer": ScriptWriterAgent(),
            "video_generator": VideoGeneratorAgent(),
            "editor": EditorAgent(),
            "reviewer": ReviewerAgent()
        }
        self.workflow_engine = WorkflowEngine()
    
    async def execute_intent(
        self,
        intent: Intent,
        context: Dict[str, Any]
    ) -> AgentExecutionResult:
        """
        æ ¹æ®æ„å›¾æ‰§è¡Œç›¸åº”çš„æ™ºèƒ½ä½“å·¥ä½œæµ
        """
        
        # 1. åˆ†è§£ä»»åŠ¡
        tasks = await self._decompose_intent_to_tasks(intent, context)
        
        # 2. åˆ›å»ºå·¥ä½œæµ
        workflow = self._create_workflow(tasks)
        
        # 3. æ‰§è¡Œå·¥ä½œæµ
        result = await self.workflow_engine.execute(
            workflow,
            progress_callback=self._send_progress_update
        )
        
        # 4. èšåˆç»“æœ
        aggregated_result = await self._aggregate_results(result)
        
        return aggregated_result
    
    async def _decompose_intent_to_tasks(
        self,
        intent: Intent,
        context: Dict[str, Any]
    ) -> List[Task]:
        """
        å°†æ„å›¾åˆ†è§£ä¸ºå…·ä½“ä»»åŠ¡
        
        ç¤ºä¾‹:
        Intent: CREATE_VIDEO("æ˜¥å¤©çš„æ•…äº‹")
        Tasks:
        1. ScriptWriterAgent.write_script(theme="æ˜¥å¤©")
        2. VideoGeneratorAgent.generate_characters(script)
        3. VideoGeneratorAgent.generate_scenes(script)
        4. VideoGeneratorAgent.generate_storyboard(script, characters, scenes)
        5. VideoGeneratorAgent.generate_video(storyboard)
        6. ReviewerAgent.review_video(video)
        """
        
        if intent.type == IntentType.CREATE_VIDEO:
            return [
                Task(
                    agent="script_writer",
                    action="write_script",
                    params={"theme": intent.entities.get("theme")},
                    dependencies=[]
                ),
                Task(
                    agent="video_generator",
                    action="generate_characters",
                    params={"script": "{{script_writer.write_script.output}}"},
                    dependencies=["script_writer.write_script"]
                ),
                # ... æ›´å¤šä»»åŠ¡
            ]
        
        elif intent.type == IntentType.MODIFY_VIDEO:
            # æ ¹æ®ä¿®æ”¹ç±»å‹é€‰æ‹©åˆé€‚çš„æ™ºèƒ½ä½“
            modification_type = intent.entities.get("modification_type")
            
            if modification_type == "brightness":
                return [
                    Task(
                        agent="editor",
                        action="adjust_brightness",
                        params={
                            "shot_id": intent.entities.get("shot_id"),
                            "adjustment": intent.entities.get("adjustment")
                        }
                    )
                ]
        
        # ... å¤„ç†å…¶ä»–æ„å›¾ç±»å‹
```

### 2. Specialized Agents (ä¸“ä¸šæ™ºèƒ½ä½“)

#### 2.1 Script Writer Agent

```python
class ScriptWriterAgent(BaseAgent):
    """
    å‰§æœ¬åˆ›ä½œæ™ºèƒ½ä½“
    """
    
    async def write_script(
        self,
        theme: str,
        style: str = "cinematic",
        duration: int = 60,
        context: Dict[str, Any] = None
    ) -> Script:
        """
        åˆ›ä½œè§†é¢‘å‰§æœ¬
        """
        
        prompt = f"""
        åˆ›ä½œä¸€ä¸ªå…³äº"{theme}"çš„{duration}ç§’çŸ­è§†é¢‘å‰§æœ¬ã€‚
        é£æ ¼: {style}
        
        è¦æ±‚:
        1. åŒ…å«æ¸…æ™°çš„æ•…äº‹ç»“æ„(å¼€å§‹ã€å‘å±•ã€é«˜æ½®ã€ç»“å°¾)
        2. æè¿°ä¸»è¦è§’è‰²å’Œåœºæ™¯
        3. åŒ…å«å¯¹è¯æˆ–æ—ç™½
        4. é€‚åˆè§†è§‰å‘ˆç°
        
        è¾“å‡ºæ ¼å¼: JSON
        """
        
        script_json = await self.llm.generate(prompt)
        
        return Script.from_json(script_json)
    
    async def refine_script(
        self,
        script: Script,
        feedback: str
    ) -> Script:
        """
        æ ¹æ®åé¦ˆä¼˜åŒ–å‰§æœ¬
        """
        
        prompt = f"""
        åŸå‰§æœ¬:
        {script.to_text()}
        
        ç”¨æˆ·åé¦ˆ:
        {feedback}
        
        è¯·æ ¹æ®åé¦ˆä¼˜åŒ–å‰§æœ¬ï¼Œä¿æŒæ•…äº‹è¿è´¯æ€§ã€‚
        """
        
        refined_json = await self.llm.generate(prompt)
        
        return Script.from_json(refined_json)
```

#### 2.2 Video Generator Agent

```python
class VideoGeneratorAgent(BaseAgent):
    """
    è§†é¢‘ç”Ÿæˆæ™ºèƒ½ä½“
    """
    
    async def generate_video_from_script(
        self,
        script: Script,
        style: str,
        progress_callback: Callable = None
    ) -> Video:
        """
        ä»å‰§æœ¬ç”Ÿæˆå®Œæ•´è§†é¢‘
        """
        
        # 1. ç”Ÿæˆè§’è‰²
        if progress_callback:
            await progress_callback(0.1, "æ­£åœ¨ç”Ÿæˆè§’è‰²...")
        
        characters = await self._generate_characters(script, style)
        
        # 2. ç”Ÿæˆåœºæ™¯
        if progress_callback:
            await progress_callback(0.3, "æ­£åœ¨ç”Ÿæˆåœºæ™¯...")
        
        scenes = await self._generate_scenes(script, style)
        
        # 3. ç”Ÿæˆåˆ†é•œ
        if progress_callback:
            await progress_callback(0.5, "æ­£åœ¨ç”Ÿæˆåˆ†é•œ...")
        
        storyboard = await self._generate_storyboard(
            script, characters, scenes
        )
        
        # 4. ç”Ÿæˆè§†é¢‘ç‰‡æ®µ
        if progress_callback:
            await progress_callback(0.7, "æ­£åœ¨ç”Ÿæˆè§†é¢‘ç‰‡æ®µ...")
        
        video_clips = await self._generate_video_clips(
            storyboard, characters, scenes
        )
        
        # 5. åˆæˆæœ€ç»ˆè§†é¢‘
        if progress_callback:
            await progress_callback(0.9, "æ­£åœ¨åˆæˆè§†é¢‘...")
        
        final_video = await self._compose_video(video_clips)
        
        if progress_callback:
            await progress_callback(1.0, "è§†é¢‘ç”Ÿæˆå®Œæˆï¼")
        
        return final_video
```

#### 2.3 Editor Agent

```python
class EditorAgent(BaseAgent):
    """
    è§†é¢‘ç¼–è¾‘æ™ºèƒ½ä½“
    """
    
    async def adjust_brightness(
        self,
        video: Video,
        shot_id: str,
        adjustment: float
    ) -> Video:
        """è°ƒæ•´é•œå¤´äº®åº¦"""
        
        shot = video.get_shot(shot_id)
        edited_shot = await self.video_processor.adjust_brightness(
            shot, adjustment
        )
        
        return video.replace_shot(shot_id, edited_shot)
    
    async def add_transition(
        self,
        video: Video,
        between_shots: Tuple[str, str],
        transition_type: str
    ) -> Video:
        """æ·»åŠ è½¬åœºæ•ˆæœ"""
        
        return await self.video_processor.add_transition(
            video, between_shots, transition_type
        )
    
    async def trim_shot(
        self,
        video: Video,
        shot_id: str,
        start_time: float,
        end_time: float
    ) -> Video:
        """è£å‰ªé•œå¤´"""
        
        shot = video.get_shot(shot_id)
        trimmed_shot = await self.video_processor.trim(
            shot, start_time, end_time
        )
        
        return video.replace_shot(shot_id, trimmed_shot)
```

#### 2.4 Reviewer Agent

```python
class ReviewerAgent(BaseAgent):
    """
    è§†é¢‘è¯„å®¡æ™ºèƒ½ä½“
    """
    
    async def review_video(
        self,
        video: Video,
        script: Script
    ) -> ReviewResult:
        """
        è¯„å®¡è§†é¢‘è´¨é‡å’Œä¸€è‡´æ€§
        """
        
        # 1. æ£€æŸ¥ä¸å‰§æœ¬çš„ä¸€è‡´æ€§
        consistency_score = await self._check_script_consistency(
            video, script
        )
        
        # 2. è¯„ä¼°è§†è§‰è´¨é‡
        visual_quality = await self._assess_visual_quality(video)
        
        # 3. æ£€æŸ¥æµç•…åº¦
        flow_score = await self._check_flow(video)
        
        # 4. ç”Ÿæˆæ”¹è¿›å»ºè®®
        suggestions = await self._generate_suggestions(
            video, consistency_score, visual_quality, flow_score
        )
        
        return ReviewResult(
            overall_score=(consistency_score + visual_quality + flow_score) / 3,
            consistency_score=consistency_score,
            visual_quality=visual_quality,
            flow_score=flow_score,
            suggestions=suggestions
        )
```

### 3. Workflow Engine (å·¥ä½œæµå¼•æ“)

```python
class WorkflowEngine:
    """
    æ‰§è¡Œæ™ºèƒ½ä½“å·¥ä½œæµ
    """
    
    async def execute(
        self,
        workflow: Workflow,
        progress_callback: Callable = None
    ) -> WorkflowResult:
        """
        æ‰§è¡Œå·¥ä½œæµ
        
        æ”¯æŒ:
        - é¡ºåºæ‰§è¡Œ
        - å¹¶è¡Œæ‰§è¡Œ
        - æ¡ä»¶åˆ†æ”¯
        - é”™è¯¯é‡è¯•
        - çŠ¶æ€æŒä¹…åŒ–
        """
        
        execution_context = ExecutionContext(
            workflow_id=workflow.id,
            start_time=datetime.now()
        )
        
        try:
            # æŒ‰ä¾èµ–å…³ç³»æ’åºä»»åŠ¡
            sorted_tasks = self._topological_sort(workflow.tasks)
            
            # æ‰§è¡Œä»»åŠ¡
            for task in sorted_tasks:
                # æ£€æŸ¥ä¾èµ–æ˜¯å¦å®Œæˆ
                if not self._dependencies_satisfied(task, execution_context):
                    await self._wait_for_dependencies(task, execution_context)
                
                # æ‰§è¡Œä»»åŠ¡
                result = await self._execute_task(
                    task,
                    execution_context,
                    progress_callback
                )
                
                # ä¿å­˜ç»“æœ
                execution_context.task_results[task.id] = result
                
                # æŒä¹…åŒ–çŠ¶æ€
                await self._save_state(execution_context)
            
            return WorkflowResult(
                success=True,
                results=execution_context.task_results,
                execution_time=datetime.now() - execution_context.start_time
            )
            
        except Exception as e:
            # é”™è¯¯å¤„ç†å’Œæ¢å¤
            return await self._handle_workflow_error(
                e, execution_context, workflow
            )
```

---

## ğŸ’¬ å¯¹è¯äº¤äº’è®¾è®¡

### å¯¹è¯æµç¨‹ç¤ºä¾‹

#### åœºæ™¯1: åˆ›å»ºæ–°è§†é¢‘

```
User: "å¸®æˆ‘åˆ›å»ºä¸€ä¸ªå…³äºæ˜¥å¤©çš„30ç§’çŸ­è§†é¢‘"

System: "å¥½çš„ï¼æˆ‘å°†ä¸ºæ‚¨åˆ›å»ºä¸€ä¸ªæ˜¥å¤©ä¸»é¢˜çš„30ç§’çŸ­è§†é¢‘ã€‚
        
        ğŸ“ æ­£åœ¨æ„æ€å‰§æœ¬...
        
        [Script Writer Agent å·¥ä½œä¸­]"

System: "âœ… å‰§æœ¬åˆ›ä½œå®Œæˆï¼
        
        æ•…äº‹æ¦‚è¦:
        æ˜¥å¤©æ¥ä¸´ï¼ŒèŠ±å›­é‡Œçš„èŠ±æœµé€æ¸ç»½æ”¾ã€‚ä¸€åªè´è¶åœ¨èŠ±ä¸›ä¸­ç¿©ç¿©èµ·èˆï¼Œ
        æœ€ååœåœ¨ä¸€æœµç››å¼€çš„æ¨±èŠ±ä¸Šã€‚
        
        ä¸»è¦åœºæ™¯:
        1. æ¸…æ™¨çš„èŠ±å›­ (5ç§’)
        2. èŠ±æœµç»½æ”¾ç‰¹å†™ (10ç§’)
        3. è´è¶é£èˆ (10ç§’)
        4. è´è¶åœåœ¨æ¨±èŠ±ä¸Š (5ç§’)
        
        æ‚¨è§‰å¾—è¿™ä¸ªå‰§æœ¬å¦‚ä½•ï¼Ÿå¯ä»¥è¯´"ç»§ç»­ç”Ÿæˆ"æˆ–æå‡ºä¿®æ”¹å»ºè®®ã€‚"

User: "å¾ˆå¥½ï¼Œç»§ç»­ç”Ÿæˆè§†é¢‘"

System: "å¼€å§‹ç”Ÿæˆè§†é¢‘...
        
        ğŸ¨ æ­£åœ¨ç”Ÿæˆè§’è‰²å’Œåœºæ™¯... (30%)
        [Video Generator Agent å·¥ä½œä¸­]"

System: "ğŸ¬ æ­£åœ¨ç”Ÿæˆåˆ†é•œ... (60%)
        [Video Generator Agent å·¥ä½œä¸­]"

System: "ğŸ¥ æ­£åœ¨åˆæˆè§†é¢‘... (90%)
        [Video Generator Agent å·¥ä½œä¸­]"

System: "âœ… è§†é¢‘ç”Ÿæˆå®Œæˆï¼
        
        [è§†é¢‘é¢„è§ˆç¼©ç•¥å›¾]
        
        ğŸ“Š è´¨é‡è¯„ä¼°:
        - è§†è§‰è´¨é‡: 9.2/10
        - æµç•…åº¦: 8.8/10
        - å‰§æœ¬ä¸€è‡´æ€§: 9.5/10
        
        æ‚¨å¯ä»¥:
        - è¯´"æ’­æ”¾è§†é¢‘"æŸ¥çœ‹å®Œæ•´è§†é¢‘
        - è¯´"ä¸‹è½½è§†é¢‘"ä¿å­˜åˆ°æœ¬åœ°
        - æå‡ºä¿®æ”¹å»ºè®®(å¦‚"ç¬¬äºŒä¸ªé•œå¤´å¤ªæš—äº†")"

User: "ç¬¬ä¸‰ä¸ªé•œå¤´çš„è´è¶é£å¾—å¤ªå¿«äº†ï¼Œèƒ½æ…¢ä¸€äº›å—ï¼Ÿ"

System: "å¥½çš„ï¼Œæˆ‘æ¥è°ƒæ•´ç¬¬ä¸‰ä¸ªé•œå¤´çš„é€Ÿåº¦...
        
        ğŸ¬ æ­£åœ¨ç¼–è¾‘... (Editor Agent å·¥ä½œä¸­)"

System: "âœ… å·²è°ƒæ•´å®Œæˆï¼
        
        [æ›´æ–°çš„é¢„è§ˆ]
        
        ç°åœ¨è´è¶çš„é£è¡Œé€Ÿåº¦é™ä½äº†30%ï¼Œçœ‹èµ·æ¥æ›´ä¼˜é›…äº†ã€‚
        è¿˜éœ€è¦å…¶ä»–è°ƒæ•´å—ï¼Ÿ"
```

#### åœºæ™¯2: è¿­ä»£ä¼˜åŒ–

```
User: "èƒ½æŠŠæ•´ä¸ªè§†é¢‘çš„è‰²è°ƒè°ƒå¾—æ›´æ¸©æš–ä¸€äº›å—ï¼Ÿ"

System: "å¥½çš„ï¼Œæˆ‘å°†ä¸ºæ•´ä¸ªè§†é¢‘æ·»åŠ æ¸©æš–çš„è‰²è°ƒ...
        
        ğŸ¨ æ­£åœ¨è°ƒæ•´è‰²å½©... (Editor Agent å·¥ä½œä¸­)"

System: "âœ… è‰²è°ƒè°ƒæ•´å®Œæˆï¼
        
        [å¯¹æ¯”å›¾: è°ƒæ•´å‰ vs è°ƒæ•´å]
        
        å·²ä¸ºè§†é¢‘æ·»åŠ äº†æ¸©æš–çš„æ©™é»„è‰²è°ƒï¼Œæ›´ç¬¦åˆæ˜¥å¤©çš„æ°›å›´ã€‚
        æ•ˆæœæ»¡æ„å—ï¼Ÿ"

User: "å®Œç¾ï¼ç°åœ¨å¯ä»¥ä¸‹è½½äº†"

System: "å¤ªå¥½äº†ï¼è§†é¢‘å·²å‡†å¤‡å¥½ä¸‹è½½ã€‚
        
        ğŸ“¥ [ä¸‹è½½è§†é¢‘] (MP4, 1920x1080, 30fps, 5.2MB)
        
        æ„Ÿè°¢ä½¿ç”¨ï¼å¦‚æœéœ€è¦åˆ›å»ºæ›´å¤šè§†é¢‘æˆ–è¿›è¡Œå…¶ä»–ç¼–è¾‘ï¼Œ
        éšæ—¶å‘Šè¯‰æˆ‘ã€‚"
```

### å¯¹è¯å“åº”æ¨¡æ¿

```python
class ConversationalResponseGenerator:
    """
    ç”Ÿæˆè‡ªç„¶çš„å¯¹è¯å“åº”
    """
    
    RESPONSE_TEMPLATES = {
        "video_creation_started": [
            "å¥½çš„ï¼æˆ‘å°†ä¸ºæ‚¨åˆ›å»º{description}ã€‚",
            "æ˜ç™½äº†ï¼å¼€å§‹åˆ›ä½œ{description}...",
            "æ”¶åˆ°ï¼è®©æˆ‘ä¸ºæ‚¨åˆ¶ä½œ{description}ã€‚"
        ],
        
        "progress_update": [
            "ğŸ¨ æ­£åœ¨{action}... ({progress}%)",
            "â³ {action}ä¸­ï¼Œè¯·ç¨å€™... ({progress}%)",
            "ğŸ“Š è¿›åº¦: {action} - {progress}%å®Œæˆ"
        ],
        
        "completion": [
            "âœ… {task}å®Œæˆï¼",
            "ğŸ‰ {task}å·²å®Œæˆï¼",
            "ğŸ‘ {task}æˆåŠŸï¼"
        ],
        
        "request_feedback": [
            "æ‚¨è§‰å¾—{item}å¦‚ä½•ï¼Ÿ",
            "{item}æ•ˆæœæ»¡æ„å—ï¼Ÿ",
            "å¯¹{item}æœ‰ä»€ä¹ˆå»ºè®®å—ï¼Ÿ"
        ],
        
        "modification_started": [
            "å¥½çš„ï¼Œæˆ‘æ¥{action}...",
            "æ˜ç™½äº†ï¼Œæ­£åœ¨{action}...",
            "æ”¶åˆ°ï¼å¼€å§‹{action}..."
        ]
    }
    
    def generate_response(
        self,
        template_key: str,
        **kwargs
    ) -> str:
        """ç”Ÿæˆè‡ªç„¶çš„å“åº”"""
        
        templates = self.RESPONSE_TEMPLATES.get(template_key, [])
        template = random.choice(templates)
        
        return template.format(**kwargs)
```

---

## ğŸ”„ çŠ¶æ€ç®¡ç†

### Project State Schema

```python
class ProjectState:
    """
    é¡¹ç›®çŠ¶æ€
    """
    
    project_id: str
    created_at: datetime
    updated_at: datetime
    
    # å‰§æœ¬çŠ¶æ€
    script: Optional[Script] = None
    script_version: int = 0
    script_status: ScriptStatus = ScriptStatus.NOT_STARTED
    
    # è§†é¢‘ç”ŸæˆçŠ¶æ€
    characters: List[Character] = []
    scenes: List[Scene] = []
    storyboard: List[Shot] = []
    video: Optional[Video] = None
    video_status: VideoStatus = VideoStatus.NOT_STARTED
    
    # å·¥ä½œæµçŠ¶æ€
    active_workflows: List[WorkflowExecution] = []
    completed_tasks: List[Task] = []
    pending_tasks: List[Task] = []
    
    # ç”¨æˆ·äº¤äº’
    conversation_history: List[Message] = []
    user_preferences: Dict[str, Any] = {}
    
    # ç‰ˆæœ¬å†å²
    versions: List[ProjectVersion] = []
    
    def create_snapshot(self) -> ProjectVersion:
        """åˆ›å»ºå½“å‰çŠ¶æ€å¿«ç…§"""
        return ProjectVersion(
            version_number=len(self.versions) + 1,
            timestamp=datetime.now(),
            script=self.script.copy() if self.script else None,
            video=self.video.copy() if self.video else None,
            description=f"Version {len(self.versions) + 1}"
        )
    
    def rollback_to_version(self, version_number: int):
        """å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬"""
        version = next(
            (v for v in self.versions if v.version_number == version_number),
            None
        )
        
        if version:
            self.script = version.script
            self.video = version.video
            self.script_version = version_number
```

---

## ğŸš€ å®ç°è·¯çº¿å›¾

### Phase 1: æ ¸å¿ƒå¯¹è¯ç³»ç»Ÿ

**ç›®æ ‡**: å»ºç«‹åŸºç¡€å¯¹è¯æ¡†æ¶å’Œæ„å›¾ç†è§£

- [ ] å®ç° `ConversationalOrchestrator` æ ¸å¿ƒç±»
- [ ] å®ç° `IntentUnderstandingModule`
- [ ] å®ç° `ConversationContextManager`
- [ ] åˆ›å»ºåŸºç¡€å¯¹è¯UI
- [ ] å®ç°å¯¹è¯å†å²æŒä¹…åŒ–
- [ ] æ·»åŠ å®æ—¶WebSocketé€šä¿¡

### Phase 2: æ™ºèƒ½ä½“é›†æˆ

**ç›®æ ‡**: é›†æˆç°æœ‰pipelineä½œä¸ºæ™ºèƒ½ä½“

- [ ] åˆ›å»º `ScriptWriterAgent`
- [ ] åˆ›å»º `VideoGeneratorAgent`
- [ ] åˆ›å»º `EditorAgent`
- [ ] åˆ›å»º `ReviewerAgent`
- [ ] å®ç°æ™ºèƒ½ä½“é—´é€šä¿¡åè®®

### Phase 3: å·¥ä½œæµå¼•æ“

**ç›®æ ‡**: å®ç°çµæ´»çš„å·¥ä½œæµç¼–æ’

- [ ] å®ç° `WorkflowEngine` æ ¸å¿ƒé€»è¾‘
- [ ] æ”¯æŒä»»åŠ¡ä¾èµ–ç®¡ç†
- [ ] å®ç°å¹¶è¡Œæ‰§è¡Œ
- [ ] æ·»åŠ é”™è¯¯æ¢å¤æœºåˆ¶
- [ ] å®ç°çŠ¶æ€æŒä¹…åŒ–å’Œæ¢å¤

### Phase 4: é«˜çº§å¯¹è¯åŠŸèƒ½

**ç›®æ ‡**: å¢å¼ºå¯¹è¯ä½“éªŒ

- [ ] å®ç°å¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡ç†è§£
- [ ] æ·»åŠ ä¸»åŠ¨å»ºè®®åŠŸèƒ½
- [ ] å®ç°è¯­éŸ³è¾“å…¥æ”¯æŒ
- [ ] æ·»åŠ è§†é¢‘é¢„è§ˆå†…åµŒ
- [ ] å®ç°ç‰ˆæœ¬ç®¡ç†å’Œå›æ»š

### Phase 5: ä¼˜åŒ–å’Œæµ‹è¯•

**ç›®æ ‡**: æ€§èƒ½ä¼˜åŒ–å’Œå…¨é¢æµ‹è¯•

- [ ] æ€§èƒ½ä¼˜åŒ–(ç¼“å­˜ã€å¹¶è¡Œ)
- [ ] æ·»åŠ å•å…ƒæµ‹è¯•
- [ ] æ·»åŠ é›†æˆæµ‹è¯•
- [ ] ç”¨æˆ·ä½“éªŒæµ‹è¯•
- [ ] æ–‡æ¡£å®Œå–„

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [APIæ•´åˆè§„åˆ’](../03-api-integration/API_INTEGRATION_PLAN.md)
- [ç»Ÿä¸€APIè®¾è®¡](../03-api-integration/UNIFIED_API_DESIGN.md)